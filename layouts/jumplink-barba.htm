description = "Inhaltsseite ohne Titel"

[staticPage]
useContent = 1
default = 0

[contenteditor]
==
<?php
use Debugbar as Debugbar;

/**
 * Generate a math captcha challenge
 * Returns two visible numbers and one hidden number (honeypot)
 * The user should only add the visible numbers, bots may add all three
 */
function onGetMathChallenge() {
    $num1 = rand(1, 9);
    $num2 = rand(1, 9);
    $numHidden = rand(1, 9);

    // Generate unique token for this challenge
    $token = bin2hex(random_bytes(16));

    // Store the expected answer (only visible numbers) with the token
    $expectedAnswer = $num1 + $num2;
    \Session::put($this->mathCaptchaKey($token), $expectedAnswer);

    \Log::debug('[MathCaptcha] Generated challenge', [
        'token' => $token,
        'expectedAnswer' => $expectedAnswer
    ]);

    // Return as explicit JSON response
    return \Response::json([
        'num1' => $num1,
        'num2' => $num2,
        'numHidden' => $numHidden,
        'token' => $token
    ]);
}

/**
 * Validate the math captcha answer
 * Returns true if valid, throws exception if invalid
 */
function validateMathCaptcha() {
    $token = trim((string) post('captcha_token'));
    $userAnswerRaw = post('captcha_answer');

    \Log::debug('[MathCaptcha] Validating', [
        'token' => $token,
        'userAnswer' => $userAnswerRaw
    ]);

    if ($token === '' || $userAnswerRaw === null || $userAnswerRaw === '') {
        throw new \ApplicationException('Sicherheitsüberprüfung fehlgeschlagen. Bitte laden Sie die Seite neu.');
    }

    $userAnswer = (int) $userAnswerRaw;
    $sessionKey = $this->mathCaptchaKey($token);
    $expectedAnswer = \Session::pull($sessionKey);

    \Log::debug('[MathCaptcha] Session lookup', [
        'sessionKey' => $sessionKey,
        'expectedAnswer' => $expectedAnswer
    ]);

    if ($expectedAnswer === null) {
        throw new \ApplicationException('Sicherheitsüberprüfung abgelaufen. Bitte laden Sie die Seite neu.');
    }

    if ($userAnswer !== (int) $expectedAnswer) {
        \Log::debug('[MathCaptcha] Answer mismatch', [
            'userAnswer' => $userAnswer,
            'expectedAnswer' => $expectedAnswer
        ]);
        throw new \ApplicationException('Die Rechenaufgabe wurde nicht korrekt gelöst.');
    }

    \Log::debug('[MathCaptcha] Validation passed');
    return true;
}

/**
 * Build the session key for a given token.
 */
function mathCaptchaKey(string $token) {
    return 'math_captcha_' . $token;
}

function onSubmitContact() {
    // FIRST LINE - log immediately to verify handler is called
    \Log::info('[Contact] Handler called with POST: ' . json_encode(post()));

    // Validate math captcha first
    $this->validateMathCaptcha();

    // Helper to read either flat or nested contact[...] keys
    $getContactVal = function($key, $fallback = '') {
        $flat = trim((string) post($key, ''));
        if ($flat !== '') {
            return $flat;
        }
        $nested = post('contact', []);
        if (is_array($nested) && isset($nested[$key])) {
            return trim((string) $nested[$key]);
        }
        return $fallback;
    };

    // Validate user email (supports contact[email] or email)
    $userEmail = $getContactVal('email');
    if ($userEmail === '' || !filter_var($userEmail, FILTER_VALIDATE_EMAIL)) {
        throw new \ApplicationException('Bitte eine gültige E-Mail-Adresse angeben.');
    }

    // Validate theme email (receiver)
    $ownerEmail = $this->theme->email_address ?? null;
    if (empty($ownerEmail) || !filter_var($ownerEmail, FILTER_VALIDATE_EMAIL)) {
        \Log::error('[Contact] Missing or invalid theme email_address');
        throw new \ApplicationException('Empfänger-Adresse nicht konfiguriert. Bitte später erneut versuchen.');
    }

    $name = $getContactVal('name');
    $phone = $getContactVal('phone');
    $messageText = $getContactVal('message', $getContactVal('problem_description'));

    \Log::info('Used contact form '.$name);

    $vars = [
        'name' => $name,
        'email' => $userEmail,
        'phone' => $phone,
        'userMessage' => $messageText,
    ];


    $buildOwnerMessage = function ($message) use ($vars) {
        $message->to($this->theme->email_address, $this->theme->site_name ?: 'Site');
    };

    $buildSenderMessage = function ($message) use ($vars) {
        $message->to($vars['email'], $vars['name']);
    };

    // mail to site owner and sender
    try {
        Mail::send('frontend::contact.notify', $vars, $buildOwnerMessage);
        Mail::send('frontend::contact.notify-copy', $vars, $buildSenderMessage);
        \Log::debug('[Contact] Mails sent successfully');
    } catch (\Exception $e) {
        \Log::error('[Contact] Mail send failed: ' . $e->getMessage());
        throw new \ApplicationException('Nachricht konnte nicht verschickt werden. Bitte später erneut versuchen.');
    }

    $this['result'] = "Nachricht abgeschickt";

    // Return the partial update explicitly
    return [
        '.confirm-container' => $this->renderPartial('jumplink-forms/confirm')
    ];
}


function onReguestEvent() {
    
    // get request data
    $input = Input::all();
    
    $vars = [
        'name' =>          isset($input['name']) ? $input['name'] : '',
        'lastname' =>      isset($input['lastname']) ? $input['lastname'] : '',
        'email' =>         isset($input['email']) ? $input['email'] : '',
        'phone' =>         isset($input['phone']) ? $input['phone'] : '',
        'quantity' =>      isset($input['quantity']) ? $input['quantity'] : '',
        'street' =>        isset($input['street']) ? $input['street'] : '',
        'zip' =>           isset($input['zip']) ? $input['zip'] : '',
        'date' =>          isset($input['date']) ? $input['date'] : '',
        'total' =>         isset($input['total']) ? $input['total'] : '',
        'eventID' =>       isset($input['event']['id']) ? $input['event']['id'] : '',
        'eventTitle' =>    isset($input['event']['title']) ? $input['event']['title'] : '',
        'eventSubtitle' => isset($input['event']['subtitle']) ? $input['event']['subtitle'] : '',
        'eventDescription' => isset($input['event']['description']) ? $input['event']['description'] : '',
        'eventCalendar' =>    isset($input['event']['calendar']) ? $input['event']['calendar'] : '',
    ];
    
    $notifications = isset($input['event']['notifications']) ? $input['event']['notifications'] : null;
    
    if($notifications == null) {
        $notifications = [];
        $notifications[] = [
            'email' => $this->theme->email_address,
            'name' => $this->theme->site_name,
        ];
    }
    
    // Debugbar::info('[onReguestEvent] $notifications', $notifications);
    
    $notificationSwipftMailFormat = array();
    foreach ($notifications as $notification) {
        $notificationSwipftMailFormat[$notification['email']] = $notification['name'];
    }
    
    // Debugbar::info('[onReguestEvent] $notificationSwipftMailFormat', $notificationSwipftMailFormat);
    
    \Log::info('Book event, Name:'.$input['name'].' '.$input['lastname'].' E-Mail:'.$input['email'].' Event ID'.$input['event']['id'].' Menge: '.$input['quantity']);
        
    Mail::send('frontend::event.book', $vars, function($message) use ($notificationSwipftMailFormat) {
        $message->from($this->theme->email_address,  $this->theme->site_name);
        $message->to($notificationSwipftMailFormat);
    });
    
    
    // mail to contact sender
    Mail::send('frontend::event.book-copy', $vars, function($message) use ($vars) {
        $message->to($vars['email'], $vars['name'].' '.$vars['lastname']);
    });
    
    return \Response::json($input);
}
?>
==
<!DOCTYPE html>
<html lang="de">
    {% partial 'jumplink-layout-head' %}
    <body id="body-{{ str_studly(this.page.title) | lower | replace({'/':'_'}) }}" data-spy="scroll">
        {# Content #}
        <div id="layout-content">
            {% partial 'jumplink-fixed-logo' sourceLogo='assets/images/logo-just.svg' sourceText='assets/images/logo-text.svg' position='top-left' width= '10rem' alt='Logo von'~this.theme.site_name %}
            {% partial 'jumplink-navigation/navbar_only-sidebar' %}
            <div id="barba-wrapper">
                <div {% partial 'jumplink-barba-container-attributes' %}>
                    <div class="py-5">
                        {% page %}
                    </div>
                </div>
            </div>
        </div>
        {% partial 'jumplink-footer' %}
        {% partial 'jumplink-layout-barba-body' %}
    </body>
</html>