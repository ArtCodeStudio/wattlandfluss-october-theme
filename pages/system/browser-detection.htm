title = "Über deinen Browser"
url = "/browser-detection"
layout = "jumplink-barba"
description = "Browsererkennung, veraltete Browser werden erkannt und Schritte zur Aktualisierung beschrieben oder alternative Browser angeboten."
is_hidden = 0
contentType = "html"
meta_title = "Über deinen Browser"
meta_description = "Über deinen Browser"
robot_index = "index"
robot_follow = "follow"
==
<?php
/**
 * Build session key for math captcha
 */
function mathCaptchaKey(string $token) {
    return 'math_captcha_' . $token;
}

/**
 * Validate math captcha answer
 */
function validateMathCaptcha() {
    $token = trim((string) post('captcha_token'));
    $userAnswerRaw = post('captcha_answer');

    \Log::debug('[MathCaptcha][BrowserDetection] Validating', [
        'token' => $token,
        'userAnswer' => $userAnswerRaw
    ]);

    if ($token === '' || $userAnswerRaw === null || $userAnswerRaw === '') {
        throw new \ApplicationException('Sicherheitsüberprüfung fehlgeschlagen. Bitte laden Sie die Seite neu.');
    }

    $userAnswer = (int) $userAnswerRaw;
    $sessionKey = $this->mathCaptchaKey($token);
    $expectedAnswer = \Session::pull($sessionKey);

    if ($expectedAnswer === null) {
        throw new \ApplicationException('Sicherheitsüberprüfung abgelaufen. Bitte laden Sie die Seite neu.');
    }

    if ($userAnswer !== (int) $expectedAnswer) {
        throw new \ApplicationException('Die Rechenaufgabe wurde nicht korrekt gelöst.');
    }

    return true;
}

function onSubmitBrowserForm() {
    
    \Log::info('Contact from in browser detection from user: '.post('contact[firstname]'));
    
    // Validate math captcha
    $this->validateMathCaptcha();

    // Basic validation
    $email = trim((string) post('contact[email]'));
    if ($email === '' || !filter_var($email, FILTER_VALIDATE_EMAIL)) {
        throw new \ApplicationException('Bitte eine gültige E-Mail-Adresse angeben.');
    }
    
    $vars = [
        'firstname'     => trim((string) post('contact[firstname]')),
        'name'          => trim((string) post('contact[name]')),
        'email'         => $email,
        'phone'         => trim((string) post('contact[phone]')),
        'browser'       => trim((string) post('contact[browser]')),
        'version'       => trim((string) post('contact[version]')),
        'os'            => trim((string) post('contact[os]')),
        'engine'        => trim((string) post('contact[engine]')),
        'problem_description' => trim((string) post('contact[problem_description]')),
    ];
    
    $buildOwnerMessage = function ($message) use ($vars) {
        // TODO use email and name from backend or theme settings
        $message->to('info@jumplink.me', 'watt-land-fluss.de');
    };
  
    $buildSenderMessage = function ($message) use ($vars) {
        $message->to($vars['email'] , $vars['firstname'].' '.$vars['name']);
    };

    // mail to site owner
    try {
        Mail::send('frontend::browser.notify', $vars, $buildOwnerMessage);
        
        // mail to contact sender
        Mail::send('frontend::browser.notify-copy', $vars, $buildSenderMessage);
    } catch (\Exception $e) {
        \Log::error('[BrowserDetection] Mail send failed: '.$e->getMessage());
        throw new \ApplicationException('Nachricht konnte nicht verschickt werden. Bitte später erneut versuchen.');
    }

    $this['result'] = "Nachricht abgeschickt";
    return [
        '.confirm-container' => $this->renderPartial('jumplink-forms/confirm')
    ];
}
?>
==
{#
 # Please create two Mail Temaptes for the contact form
 # 
 # @example for confirmation email
 # id: frontend::contact.notify-copy
 #
 # <p><strong>Danke für deine Anfrage</strong></p>
 # <p><strong>Name:</strong> {{firstname}} {{name}}</p>
 # <p><strong>Absender:</strong> {{email}}</p>
 # <p><strong>Telefon:</strong> {{phone}}</p>
 # <p><strong>Browser:</strong> {{browser}}</p>
 # <p><strong>Version:</strong> {{version}}</p>
 # <p><strong>Betriebssystem:</strong> {{os}}</p>
 # <p><strong>Engine:</strong> {{engine}}</p>
 # <p><strong>Problembeschreibung:</strong> {{problem_description}}</p>
 #
 # @example for site owner notification email
 # id: frontend::contact.notify
 #
 # <p><strong>Neue Anfrage</strong>
 # <p><strong>Name:</strong> {{firstname}} {{name}}</p>
 # <p><strong>Absender:</strong> {{email}}</p>
 # <p><strong>Telefon:</strong> {{phone}}</p>
 # <p><strong>Browser:</strong> {{browser}}</p>
 # <p><strong>Version:</strong> {{version}}</p>
 # <p><strong>Betriebssystem:</strong> {{os}}</p>
 # <p><strong>Engine:</strong> {{engine}}</p>
 # <p><strong>Problembeschreibung:</strong> {{problem_description}}</p>
 #
 ##}

<div class="container" id="browser-info">
    <div class="row">
        <div class="col-xs-12">
            <h1 class="text-center hidden">{{ page.title }}</h1>
        </div>
        <div class="col-xs-12 rte">
            {{ page.content }}
        </div>
        
        <browser-detection-form></browser-detection-form>
        
    </div>
</div>